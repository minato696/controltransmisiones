// src/utils/targetMapping.js - CORREGIDO para manejo correcto de "Otro" ‚Üî "Otros"

/**
 * Sistema centralizado de mapeo entre abreviaturas de Target del frontend y valores del backend
 * CORREGIDO: Manejo espec√≠fico para "Otro" (backend) ‚Üî "Otros" (frontend)
 */

// ==================== MAPEOS PRINCIPALES ====================

/**
 * Mapeo de abreviaturas del frontend a valores enum del backend
 */
export const targetToBackendEnum = {
  "Tde": "Tarde",
  "Fta": "Falta",
  "Enf": "Enfermedad",
  "P. Tec": "Problema_tecnico",
  "F. Serv": "Falla_de_servicios",
  "Otros": "Otro"  // IMPORTANTE: Frontend usa "Otros", Backend usa "Otro"
};

/**
 * Mapeo inverso: valores enum del backend a abreviaturas del frontend
 */
export const enumToTargetAbbr = {
  "Tarde": "Tde",
  "Falta": "Fta", 
  "Enfermedad": "Enf",
  "Problema_tecnico": "P. Tec",
  "Falla_de_servicios": "F. Serv",
  "Otro": "Otros"  // IMPORTANTE: Backend usa "Otro", Frontend usa "Otros"
};

/**
 * Mapeo de abreviaturas a etiquetas completas en espa√±ol
 */
export const targetToFullLabel = {
  "Tde": "Tarde",
  "Fta": "Falta",
  "Enf": "Enfermedad",
  "P. Tec": "Problema t√©cnico",
  "F. Serv": "Falla de servicios",
  "Otros": "Otros"
};

/**
 * Mapeo de valores del backend a etiquetas completas
 */
export const enumToFullLabel = {
  "Tarde": "Tarde",
  "Falta": "Falta",
  "Enfermedad": "Enfermedad",
  "Problema_tecnico": "Problema t√©cnico",
  "Falla_de_servicios": "Falla de servicios",
  "Otro": "Otros"
};

// ==================== OPCIONES PARA UI ====================

/**
 * Opciones de target para men√∫s dropdown con formato para UI
 */
export const targetOptions = [
  { value: "Tde", label: "Tarde (Tde)" },
  { value: "Fta", label: "Falta (Fta)" },
  { value: "Enf", label: "Enfermedad (Enf)" },
  { value: "P. Tec", label: "Problema t√©cnico (P. Tec)" },
  { value: "F. Serv", label: "Falla de servicios (F. Serv)" },
  { value: "Otros", label: "Otros" }
];

// ==================== FUNCIONES DE CONVERSI√ìN ====================

/**
 * Obtiene la etiqueta de visualizaci√≥n para una abreviatura
 * @param {string} abbr - Abreviatura del target
 * @param {boolean} includeAbbr - Si incluir la abreviatura en la etiqueta
 * @returns {string} Etiqueta de visualizaci√≥n para la UI
 */
export const getTargetLabel = (abbr, includeAbbr = true) => {
  if (!abbr) return "Desconocido";
  
  const fullLabel = targetToFullLabel[abbr];
  if (!fullLabel) return abbr;
  
  if (includeAbbr && abbr !== "Otros") {
    return `${fullLabel} (${abbr})`;
  }
  
  return fullLabel;
};

/**
 * Convierte un valor enum del backend a una abreviatura del frontend - CORREGIDO
 * @param {string} backendTarget - Valor enum del backend
 * @returns {string|null} Abreviatura del frontend o null si no existe
 */
export const convertBackendTargetToAbbr = (backendTarget) => {
  if (!backendTarget) return null;
  
  console.log('üîÑ MAPEO - convertBackendTargetToAbbr - Input:', backendTarget);
  
  // 1. CASO ESPECIAL PRIORITARIO: "Otro" del backend ‚Üí "Otros" del frontend
  if (backendTarget === 'Otro') {
    console.log('‚úÖ MAPEO - Conversi√≥n especial: "Otro" ‚Üí "Otros"');
    return 'Otros';
  }
  
  // 2. Conversi√≥n directa usando el mapeo
  const abreviatura = enumToTargetAbbr[backendTarget];
  if (abreviatura) {
    console.log('‚úÖ MAPEO - convertBackendTargetToAbbr - Output (directo):', abreviatura);
    return abreviatura;
  }
  
  // 3. Normalizaci√≥n y b√∫squeda
  const normalizedInput = normalizeTargetValue(backendTarget);
  
  for (const [enumValue, abbr] of Object.entries(enumToTargetAbbr)) {
    const normalizedEnum = normalizeTargetValue(enumValue);
    
    if (normalizedEnum === normalizedInput) {
      console.log('‚úÖ MAPEO - convertBackendTargetToAbbr - Output (normalizado):', abbr);
      return abbr;
    }
  }
  
  // 4. B√∫squeda parcial
  for (const [enumValue, abbr] of Object.entries(enumToTargetAbbr)) {
    const normalizedEnum = normalizeTargetValue(enumValue);
    
    if (normalizedInput.includes(normalizedEnum) || normalizedEnum.includes(normalizedInput)) {
      console.log('‚úÖ MAPEO - convertBackendTargetToAbbr - Output (parcial):', abbr);
      return abbr;
    }
  }
  
  // 5. Casos especiales y variaciones
  const specialCases = getSpecialCasesBackendToAbbr();
  const specialResult = specialCases[normalizedInput];
  if (specialResult) {
    console.log('‚úÖ MAPEO - convertBackendTargetToAbbr - Output (caso especial):', specialResult);
    return specialResult;
  }
  
  // 6. Valor por defecto
  console.warn(`‚ö†Ô∏è MAPEO - No se encontr√≥ abreviatura para "${backendTarget}". Usando "Otros"`);
  return "Otros";
};

/**
 * Convierte una abreviatura del frontend a un valor enum del backend - CORREGIDO
 * @param {string} abbr - Abreviatura del frontend
 * @returns {string|null} Valor enum del backend o null si no existe
 */
export const convertAbbrToBackendTarget = (abbr) => {
  if (!abbr) return null;
  
  console.log('üîÑ MAPEO - convertAbbrToBackendTarget - Input:', abbr);
  
  // 1. CASO ESPECIAL PRIORITARIO: "Otros" del frontend ‚Üí "Otro" del backend
  if (abbr === 'Otros') {
    console.log('‚úÖ MAPEO - Conversi√≥n especial: "Otros" ‚Üí "Otro"');
    return 'Otro';
  }
  
  // 2. Conversi√≥n directa
  const enumValue = targetToBackendEnum[abbr];
  if (enumValue) {
    console.log('‚úÖ MAPEO - convertAbbrToBackendTarget - Output (directo):', enumValue);
    return enumValue;
  }
  
  // 3. Casos especiales
  const specialCases = getSpecialCasesAbbrToBackend();
  const normalizedAbbr = abbr.toLowerCase().trim();
  const specialResult = specialCases[normalizedAbbr];
  
  if (specialResult) {
    console.log('‚úÖ MAPEO - convertAbbrToBackendTarget - Output (caso especial):', specialResult);
    return specialResult;
  }
  
  // 4. Si no hay coincidencia, usar el valor original
  console.warn(`‚ö†Ô∏è MAPEO - No se encontr√≥ valor backend para "${abbr}". Usando valor original`);
  return abbr;
};

// ==================== FUNCIONES DE VALIDACI√ìN ====================

/**
 * Valida si una abreviatura es v√°lida - CORREGIDO
 * @param {string} abbr - Abreviatura a validar
 * @returns {boolean} True si es v√°lida
 */
export const isValidTargetAbbr = (abbr) => {
  if (!abbr) return false;
  
  // Incluir "Otros" como v√°lido expl√≠citamente
  if (abbr === 'Otros') return true;
  
  return targetToBackendEnum.hasOwnProperty(abbr);
};

/**
 * Valida si un valor enum del backend es v√°lido - CORREGIDO
 * @param {string} enumValue - Valor enum a validar
 * @returns {boolean} True si es v√°lido
 */
export const isValidBackendEnum = (enumValue) => {
  if (!enumValue) return false;
  
  // Incluir "Otro" como v√°lido expl√≠citamente
  if (enumValue === 'Otro') return true;
  
  return enumToTargetAbbr.hasOwnProperty(enumValue);
};

/**
 * Obtiene el target apropiado seg√∫n el estado de transmisi√≥n
 * @param {string} estado - Estado de transmisi√≥n (si, no, tarde, pendiente)
 * @param {string} currentTarget - Target actual (opcional)
 * @returns {string|null} Target apropiado o null
 */
export const getTargetForEstado = (estado, currentTarget = null) => {
  const estadoLower = estado?.toLowerCase();
  
  switch (estadoLower) {
    case 'si':
    case 'pendiente':
      return null; // Estos estados no requieren target
      
    case 'no':
      return currentTarget || 'Fta'; // Por defecto "Falta"
      
    case 'tarde':
      return currentTarget || 'Tde'; // Por defecto "Tarde"
      
    default:
      return currentTarget;
  }
};

// ==================== FUNCIONES AUXILIARES ====================

/**
 * Normaliza un valor de target para comparaci√≥n
 * @param {string} value - Valor a normalizar
 * @returns {string} Valor normalizado
 */
const normalizeTargetValue = (value) => {
  if (typeof value !== 'string') return '';
  
  return value
    .toLowerCase()
    .replace(/_/g, ' ')
    .replace(/\s+/g, ' ')
    .trim();
};

/**
 * Obtiene casos especiales para conversi√≥n backend a abreviatura - CORREGIDO
 * @returns {Object} Mapa de casos especiales
 */
const getSpecialCasesBackendToAbbr = () => ({
  'enfermedad': 'Enf',
  'falta': 'Fta',
  'tarde': 'Tde',
  'problema': 'P. Tec',
  'tecnico': 'P. Tec',
  'problema tecnico': 'P. Tec',
  'problema_tecnico': 'P. Tec',
  'falla': 'F. Serv',
  'servicio': 'F. Serv',
  'falla de servicios': 'F. Serv',
  'falla_de_servicios': 'F. Serv',
  'otro': 'Otros',  // CORREGIDO: "otro" (min√∫scula) ‚Üí "Otros"
  'otros': 'Otros'
});

/**
 * Obtiene casos especiales para conversi√≥n abreviatura a backend - CORREGIDO
 * @returns {Object} Mapa de casos especiales
 */
const getSpecialCasesAbbrToBackend = () => ({
  'enf': 'Enfermedad',
  'fta': 'Falta',
  'tde': 'Tarde',
  'p. tec': 'Problema_tecnico',
  'p.tec': 'Problema_tecnico',
  'ptec': 'Problema_tecnico',
  'f. serv': 'Falla_de_servicios',
  'f.serv': 'Falla_de_servicios',
  'fserv': 'Falla_de_servicios',
  'otros': 'Otro',  // CORREGIDO: "otros" (min√∫scula) ‚Üí "Otro"
  'otro': 'Otro'
});

// ==================== FUNCIONES DE PROCESAMIENTO DE REPORTES ====================

/**
 * Procesa el target de un reporte seg√∫n su estado
 * @param {Object} reporte - Objeto reporte
 * @returns {Object} Reporte con target procesado
 */
export const processReportTarget = (reporte) => {
  if (!reporte) return reporte;
  
  const estadoLower = reporte.estado?.toLowerCase();
  
  // Para "Transmiti√≥ tarde", determinar target desde el motivo
  if (estadoLower === 'tarde' && reporte.motivo && !reporte.target) {
    const targetFromMotivo = getTargetFromMotivo(reporte.motivo);
    return {
      ...reporte,
      target: targetFromMotivo
    };
  }
  
  // Para otros estados, asegurar que el target sea apropiado
  const appropriateTarget = getTargetForEstado(reporte.estado, reporte.target);
  
  if (reporte.target !== appropriateTarget) {
    return {
      ...reporte,
      target: appropriateTarget
    };
  }
  
  return reporte;
};

/**
 * Extrae el target desde un motivo para casos de "Transmiti√≥ tarde" - CORREGIDO
 * @param {string} motivo - Motivo del reporte
 * @returns {string} Target extra√≠do o 'Otros'
 */
export const getTargetFromMotivo = (motivo) => {
  if (!motivo) return 'Tde';
  
  const motivoLower = motivo.toLowerCase();
  
  // Buscar coincidencias con targets conocidos
  const motivoToTarget = {
    'tarde': 'Tde',
    'tde': 'Tde',
    'falta': 'Fta',
    'fta': 'Fta',
    'enfermedad': 'Enf',
    'enf': 'Enf',
    'problema t√©cnico': 'P. Tec',
    'problema tecnico': 'P. Tec',
    'p. tec': 'P. Tec',
    'falla de servicios': 'F. Serv',
    'f. serv': 'F. Serv'
  };
  
  for (const [key, target] of Object.entries(motivoToTarget)) {
    if (motivoLower.includes(key)) {
      return target;
    }
  }
  
  // CORREGIDO: Si no encuentra coincidencia, devolver "Otros" en lugar de "Tde"
  return 'Otros';
};

// ==================== FUNCIONES DE DEPURACI√ìN ====================

/**
 * Funci√≥n para depurar todos los mapeos y encontrar inconsistencias
 */
export const debugAllTargets = () => {
  console.log("=== SISTEMA DE MAPEO DE TARGETS ===");
  
  console.log("\n1. Mapeo Frontend ‚Üí Backend:");
  Object.entries(targetToBackendEnum).forEach(([abbr, enumVal]) => {
    console.log(`   "${abbr}" ‚Üí "${enumVal}"`);
  });
  
  console.log("\n2. Mapeo Backend ‚Üí Frontend:");
  Object.entries(enumToTargetAbbr).forEach(([enumVal, abbr]) => {
    console.log(`   "${enumVal}" ‚Üí "${abbr}"`);
  });
  
  console.log("\n3. Verificando consistencia bidireccional:");
  let inconsistencias = 0;
  
  // Verificar Frontend ‚Üí Backend ‚Üí Frontend
  Object.entries(targetToBackendEnum).forEach(([abbr, enumVal]) => {
    const reverseAbbr = enumToTargetAbbr[enumVal];
    if (reverseAbbr !== abbr) {
      console.warn(`   ‚ùå "${abbr}" ‚Üí "${enumVal}" ‚Üí "${reverseAbbr || 'undefined'}"`);
      inconsistencias++;
    } else {
      console.log(`   ‚úÖ "${abbr}" ‚Üî "${enumVal}"`);
    }
  });
  
  console.log("\n4. Probando conversiones con ejemplos reales:");
  const testCases = [
    // Backend values
    "Enfermedad",
    "Problema_tecnico",
    "Falla_de_servicios",
    "Tarde",
    "Falta",
    "Otro",
    // Frontend values
    "Enf",
    "P. Tec",
    "F. Serv",
    "Tde",
    "Fta",
    "Otros"
  ];
  
  testCases.forEach(test => {
    if (isValidBackendEnum(test)) {
      const abbr = convertBackendTargetToAbbr(test);
      const backToEnum = convertAbbrToBackendTarget(abbr);
      console.log(`   Backend: "${test}" ‚Üí "${abbr}" ‚Üí "${backToEnum}" : ${test === backToEnum ? '‚úÖ' : '‚ùå'}`);
    } else if (isValidTargetAbbr(test)) {
      const enumVal = convertAbbrToBackendTarget(test);
      const backToAbbr = convertBackendTargetToAbbr(enumVal);
      console.log(`   Frontend: "${test}" ‚Üí "${enumVal}" ‚Üí "${backToAbbr}" : ${test === backToAbbr ? '‚úÖ' : '‚ùå'}`);
    }
  });
  
  console.log(`\n5. Resumen: ${inconsistencias === 0 ? '‚úÖ Sistema consistente' : `‚ùå ${inconsistencias} inconsistencias encontradas`}`);
  
  return inconsistencias === 0;
};

/**
 * Imprime una tabla con todos los mapeos disponibles
 */
export const printTargetMappingTable = () => {
  console.log("\n‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï¶‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï¶‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó");
  console.log("‚ïë  Abreviatura   ‚ïë    Valor Backend      ‚ïë      Etiqueta UI        ‚ïë");
  console.log("‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï¨‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï¨‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£");
  
  Object.entries(targetToBackendEnum).forEach(([abbr, backend]) => {
    const label = getTargetLabel(abbr);
    console.log(`‚ïë ${abbr.padEnd(14)} ‚ïë ${backend.padEnd(21)} ‚ïë ${label.padEnd(23)} ‚ïë`);
  });
  
  console.log("‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï©‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï©‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù");
};

// ==================== EXPORT DEFAULT ====================

export default {
  // Mapeos principales
  targetToBackendEnum,
  enumToTargetAbbr,
  targetToFullLabel,
  enumToFullLabel,
  
  // Opciones para UI
  targetOptions,
  
  // Funciones de conversi√≥n
  getTargetLabel,
  convertBackendTargetToAbbr,
  convertAbbrToBackendTarget,
  
  // Funciones de validaci√≥n
  isValidTargetAbbr,
  isValidBackendEnum,
  getTargetForEstado,
  
  // Funciones de procesamiento
  processReportTarget,
  getTargetFromMotivo,
  
  // Funciones de depuraci√≥n
  debugAllTargets,
  printTargetMappingTable
};